---
variables:
  TF_PLUGIN_CACHE_DIR: "$CI_PROJECT_DIR/.terraform.d/plugin-cache"

cache:
  key: "terraform-plugins-v1"
  paths:
    - .terraform.d/plugin-cache

terraform_validate:
  stage: validate
  image:
    name: hashicorp/terraform:1.14
    entrypoint: [""]

  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes: &tf_changes
        - infrastructure/**/*.tf
        - infrastructure/**/*.hcl
        - infrastructure/**/*.tfvars
    - if: $CI_COMMIT_BRANCH == "main"
      changes: *tf_changes
    - if: $CI_PIPELINE_SOURCE == "web"

  parallel:
    matrix:
      - TF_ROOT:
          - infrastructure/01-hypervisors/01-bootstrap_cluster
          - infrastructure/01-hypervisors/02-srv01
          - infrastructure/01-hypervisors/03-srv02
          - infrastructure/02-platforms/k8s-prod
          - infrastructure/02-platforms/truenas
          - infrastructure/02-platforms/streaming-gaming-pc
  script:
    - echo "Validating $TF_ROOT..."
    - cd $TF_ROOT
    - terraform init -backend=false
    - terraform validate
